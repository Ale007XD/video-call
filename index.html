<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>–ü—Ä—è–º–æ–π –≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫ WebRTC P2P QR</title>
    <style>
    body { background: #151531; color: #fff; font-family: sans-serif; }
    .center { display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .block { background: #23235a; margin: 1em 0; padding: 1em; border-radius: 1em; width: 100%; max-width: 390px; }
    button { font-size: 20px; margin: 1em 0; width: 100%; background: #e94560; border: none; border-radius: 8px; padding: 12px; color: #fff; }
    textarea { width: 100%; min-height: 100px; margin: 7px 0; border-radius: 6px; border: 1px solid #888; padding: 8px; resize: vertical; }
    .hidden { display: none; }
    #qrcode { background:#fff; padding: 15px; border-radius: 14px; margin-top: 10px; min-height: 200px; display: flex; align-items: center; justify-content: center;}
    .error { color: #ff7785; margin: 1em 0; text-align:center;}
    .ok { color: #94ff94; }
    </style>
</head>
<body>
<div class="center"><h2>üü¢ –í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫ –º–µ–∂–¥—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞–º–∏ (QR/WebRTC)</h2>

<div id="step1" class="block">
    <b>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º:</b>
    <button onclick="asCaller()">–Ø –∑–≤–æ–Ω—é ‚Äì¬†—Å–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
    <button onclick="asAnswer()">–ú–Ω–µ –∑–≤–æ–Ω—è—Ç ‚Äì¬†—è –ø—Ä–∏–Ω–∏–º–∞—é –∑–≤–æ–Ω–æ–∫</button>
</div>

<div id="step2" class="block hidden">
    <b>1. –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —ç—Ç–∏–º –∫–ª—é—á–æ–º:</b>
    <div id="qrcode" class="hidden"></div>
    <textarea id="sdpOut" readonly></textarea>
    <button onclick="copyToClipboard()">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
    <div id="qrwarn" class="error hidden"></div>
    <hr>
    <b>2. –í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á-–æ—Ç–≤–µ—Ç –æ—Ç –≤—Ç–æ—Ä–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:</b>
    <textarea id="sdpIn" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –∫–ª—é—á-–æ—Ç–≤–µ—Ç —Å—é–¥–∞"></textarea>
    <button onclick="importRemoteDesc()">‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</button>
    <div class="error" id="startError"></div>
</div>

<div id="step3" class="block hidden">
    <b>1. –í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –æ—Ç –∑–≤–æ–Ω—è—â–µ–≥–æ:</b>
    <textarea id="sdpIn2" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –∫–ª—é—á-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ —Å—é–¥–∞ –∏–ª–∏ –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥"></textarea>
    <button onclick="importOfferDesc()">–°–æ–∑–¥–∞—Ç—å –æ—Ç–≤–µ—Ç</button>
    <div id="createWarn" class="error hidden"></div>
    <hr>
    <b>2. –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —ç—Ç–∏–º –∫–ª—é—á–æ–º-–æ—Ç–≤–µ—Ç–æ–º:</b>
    <div id="qrcode2" class="hidden"></div>
    <textarea id="sdpOut2" readonly></textarea>
    <button onclick="copyToClipboard2()">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
</div>

<div id="step4" class="block hidden">
    <div class="ok">üîó –ö–∞–Ω–∞–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω! –í–∏–¥–µ–æ –Ω–∏–∂–µ.</div>
    <video id="remoteVideo" autoplay playsinline style="width:100%;margin-top:7px;border-radius:9px;"></video>
    <video id="localVideo" autoplay playsinline muted style="width:45%;margin-top:7px;border-radius:8px;position:absolute;right:10px;top:10px;max-width:120px;max-height:100px;z-index:2;"></video>
    <button onclick="hangup()">‚ùå –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫</button>
</div>

<div style="text-align:center;font-size:13px;color:#ccc;margin-top:32px;">by @yourname, open source</div>
</div>
<!-- QRCode.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
let pc, localStream, mode, canShareQR = true;

// ---- UI STEP SWITCH ----
function show(id) {
    ['step1','step2','step3','step4'].forEach(e=>{document.getElementById(e).classList.add('hidden')});
    document.getElementById(id).classList.remove('hidden');
}

// ---- COPIER ----
function copyToClipboard() {
    const ta = document.getElementById('sdpOut');
    ta.select(); ta.setSelectionRange(0, ta.value.length);
    document.execCommand('copy');
}
function copyToClipboard2() {
    const ta = document.getElementById('sdpOut2');
    ta.select(); ta.setSelectionRange(0, ta.value.length);
    document.execCommand('copy');
}

// ---- MODE INITIATOR ----
async function asCaller() {
    mode = "caller";
    show('step2');
    document.getElementById('startError').textContent = '';
    canShareQR = true;
    try {
        localStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}, audio:true});
        document.getElementById('localVideo').srcObject = localStream;
        pc = new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
        localStream.getTracks().forEach(track=>pc.addTrack(track,localStream));
        pc.onicecandidate = e => {
            if (e.candidate === null) showOffer();
        };
        pc.ontrack = e => {
            document.getElementById('remoteVideo').srcObject = e.streams[0];
            show('step4');
        };
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
    } catch(e) {
        document.getElementById('startError').textContent = '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É';
    }
}

// ---- SHOW OFFER ----
function showOffer() {
    let sdp = JSON.stringify(pc.localDescription);
    document.getElementById('sdpOut').value = sdp;
    // QR —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –¥–ª–∏–Ω–µ ‚â§800 —Å–∏–º–≤–æ–ª–æ–≤!
    if (sdp.length <= 800) {
        document.getElementById('qrcode').classList.remove('hidden');
        new QRCode(document.getElementById('qrcode'), {text: sdp, width:230, height:230});
        document.getElementById('qrwarn').classList.add('hidden');
    } else {
        document.getElementById('qrcode').classList.add('hidden');
        document.getElementById('qrwarn').classList.remove('hidden');
        document.getElementById('qrwarn').innerHTML = 'SDP —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π –¥–ª—è QR-–∫–æ–¥–∞.<br>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ!';
        canShareQR = false;
    }
}

// ---- ANSWER SIDE ----
async function asAnswer() {
    mode = "answer";
    show('step3');
    document.getElementById('createWarn').classList.add('hidden');
}
// ---- IMPORT SDP FOR ANSWER ----
async function importOfferDesc() {
    let sdp = document.getElementById('sdpIn2').value.trim();
    if (!sdp) return;
    try {
        sdp = JSON.parse(sdp);
        localStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}, audio:true});
        document.getElementById('localVideo').srcObject = localStream;
        pc = new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
        localStream.getTracks().forEach(track=>pc.addTrack(track,localStream));
        pc.ontrack = e => {document.getElementById('remoteVideo').srcObject=e.streams[0];show('step4');};
        await pc.setRemoteDescription(new RTCSessionDescription(sdp));
        pc.onicecandidate = e => {
            if(e.candidate === null) showAnswer();
        };
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
    } catch(e) {
        document.getElementById('createWarn').classList.remove('hidden');
        document.getElementById('createWarn').textContent = '–û—à–∏–±–∫–∞! –ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π –∫–ª—é—á.';
    }
}
function showAnswer() {
    let sdp = JSON.stringify(pc.localDescription);
    document.getElementById('sdpOut2').value = sdp;
    if (sdp.length <= 800) {
        document.getElementById('qrcode2').classList.remove('hidden');
        new QRCode(document.getElementById('qrcode2'), {text: sdp, width:230, height:230});
    } else {
        document.getElementById('qrcode2').classList.add('hidden');
    }
}

// ---- CALLER completes answer ----
async function importRemoteDesc() {
    let sdp = document.getElementById('sdpIn').value.trim();
    if (!sdp) return;
    try {
        sdp = JSON.parse(sdp);
        await pc.setRemoteDescription(new RTCSessionDescription(sdp));
    } catch(e) {
        document.getElementById('startError').textContent = '–û—à–∏–±–∫–∞! –ö–ª—é—á-–æ—Ç–≤–µ—Ç –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç.';
    }
}

// ---- HANGUP ----
function hangup() {
    try { pc && pc.close(); } catch(e){}
    if(localStream) localStream.getTracks().forEach(tr=>tr.stop());
    show('step1');
}
</script>
</body>
</html>
